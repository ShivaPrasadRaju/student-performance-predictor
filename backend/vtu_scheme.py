"""
VTU 2022 Computer Science & Engineering (CSE) Scheme
Semesters 1-8 with subjects, credits, and weightages
"""

VTU_2022_CSE_SCHEME = {
    1: {
        "name": "First Semester",
        "subjects": [
            {
                "code": "23BMAT101",
                "name": "Engineering Mathematics - I",
                "type": "Core",
                "credits": 4,
                "weightage": 15  # Important foundational subject
            },
            {
                "code": "23BPHY101",
                "name": "Engineering Physics",
                "type": "Core",
                "credits": 4,
                "weightage": 10
            },
            {
                "code": "23BCHE101",
                "name": "Engineering Chemistry",
                "type": "Core",
                "credits": 3,
                "weightage": 8
            },
            {
                "code": "23BEN101",
                "name": "English for Communication",
                "type": "Core",
                "credits": 3,
                "weightage": 5
            },
            {
                "code": "23BPHY102",
                "name": "Physics Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 4
            },
            {
                "code": "23BCHE102",
                "name": "Chemistry Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 4
            },
            {
                "code": "23BESS101",
                "name": "Environmental Studies",
                "type": "Core",
                "credits": 1,
                "weightage": 2
            }
        ]
    },
    2: {
        "name": "Second Semester",
        "subjects": [
            {
                "code": "23BMAT201",
                "name": "Engineering Mathematics - II",
                "type": "Core",
                "credits": 4,
                "weightage": 15
            },
            {
                "code": "23BPHY201",
                "name": "Engineering Physics - II",
                "type": "Core",
                "credits": 4,
                "weightage": 10
            },
            {
                "code": "23BCHE201",
                "name": "Organic Chemistry",
                "type": "Core",
                "credits": 3,
                "weightage": 8
            },
            {
                "code": "23BEN201",
                "name": "Technical English",
                "type": "Core",
                "credits": 3,
                "weightage": 5
            },
            {
                "code": "23BPHY202",
                "name": "Physics Lab - II",
                "type": "Lab",
                "credits": 2,
                "weightage": 4
            },
            {
                "code": "23BCHE202",
                "name": "Chemistry Lab - II",
                "type": "Lab",
                "credits": 2,
                "weightage": 4
            }
        ]
    },
    3: {
        "name": "Third Semester",
        "subjects": [
            {
                "code": "23CS301",
                "name": "Data Structures",
                "type": "Core",
                "credits": 4,
                "weightage": 20  # Highly technical
            },
            {
                "code": "23CS302",
                "name": "Digital Logic and Computer Organization",
                "type": "Core",
                "credits": 4,
                "weightage": 18
            },
            {
                "code": "23CS303",
                "name": "Discrete Mathematics",
                "type": "Core",
                "credits": 4,
                "weightage": 15
            },
            {
                "code": "23CS304",
                "name": "Unix and Linux Systems",
                "type": "Core",
                "credits": 3,
                "weightage": 12
            },
            {
                "code": "23CS305",
                "name": "Data Structures Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 8
            },
            {
                "code": "23CS306",
                "name": "Unix and Linux Systems Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 7
            }
        ]
    },
    4: {
        "name": "Fourth Semester",
        "subjects": [
            {
                "code": "23CS401",
                "name": "Design and Analysis of Algorithms",
                "type": "Core",
                "credits": 4,
                "weightage": 20
            },
            {
                "code": "23CS402",
                "name": "Database Management Systems",
                "type": "Core",
                "credits": 4,
                "weightage": 18
            },
            {
                "code": "23CS403",
                "name": "Formal Languages and Automata Theory",
                "type": "Core",
                "credits": 4,
                "weightage": 15
            },
            {
                "code": "23CS404",
                "name": "Microprocessors and Interfacing",
                "type": "Core",
                "credits": 3,
                "weightage": 12
            },
            {
                "code": "23CS405",
                "name": "Database Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 8
            },
            {
                "code": "23CS406",
                "name": "Microprocessors Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 7
            }
        ]
    },
    5: {
        "name": "Fifth Semester",
        "subjects": [
            {
                "code": "23CS501",
                "name": "Software Engineering",
                "type": "Core",
                "credits": 4,
                "weightage": 16
            },
            {
                "code": "23CS502",
                "name": "Operating Systems",
                "type": "Core",
                "credits": 4,
                "weightage": 18
            },
            {
                "code": "23CS503",
                "name": "Computer Networks",
                "type": "Core",
                "credits": 4,
                "weightage": 18
            },
            {
                "code": "23CS504",
                "name": "Machine Learning",
                "type": "Core",
                "credits": 3,
                "weightage": 14
            },
            {
                "code": "23CS505",
                "name": "Operating Systems Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 7
            },
            {
                "code": "23CS506",
                "name": "Machine Learning Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 7
            }
        ]
    },
    6: {
        "name": "Sixth Semester",
        "subjects": [
            {
                "code": "23CS601",
                "name": "Web Technologies",
                "type": "Core",
                "credits": 4,
                "weightage": 16
            },
            {
                "code": "23CS602",
                "name": "Cloud Computing and DevOps",
                "type": "Core",
                "credits": 4,
                "weightage": 16
            },
            {
                "code": "23CS603",
                "name": "Artificial Intelligence",
                "type": "Core",
                "credits": 3,
                "weightage": 14
            },
            {
                "code": "23CS604",
                "name": "Data Science",
                "type": "Core",
                "credits": 3,
                "weightage": 14
            },
            {
                "code": "23CS605",
                "name": "Web Technologies Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 7
            },
            {
                "code": "23CS606",
                "name": "Cloud and AI Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 7
            },
            {
                "code": "23CS607",
                "name": "Elective I",
                "type": "Elective",
                "credits": 3,
                "weightage": 9
            }
        ]
    },
    7: {
        "name": "Seventh Semester",
        "subjects": [
            {
                "code": "23CS701",
                "name": "Security in Computing",
                "type": "Core",
                "credits": 4,
                "weightage": 14
            },
            {
                "code": "23CS702",
                "name": "Distributed Systems",
                "type": "Core",
                "credits": 3,
                "weightage": 12
            },
            {
                "code": "23CS703",
                "name": "Advanced Algorithms",
                "type": "Core",
                "credits": 3,
                "weightage": 12
            },
            {
                "code": "23CS704",
                "name": "Elective II",
                "type": "Elective",
                "credits": 3,
                "weightage": 8
            },
            {
                "code": "23CS705",
                "name": "Elective III",
                "type": "Elective",
                "credits": 3,
                "weightage": 8
            },
            {
                "code": "23CS706",
                "name": "Project Work",
                "type": "Project",
                "credits": 4,
                "weightage": 20
            },
            {
                "code": "23CS707",
                "name": "Security Lab",
                "type": "Lab",
                "credits": 2,
                "weightage": 6
            }
        ]
    },
    8: {
        "name": "Eighth Semester",
        "subjects": [
            {
                "code": "23CS801",
                "name": "Internship/Project",
                "type": "Project",
                "credits": 8,
                "weightage": 40
            },
            {
                "code": "23CS802",
                "name": "Professional Ethics",
                "type": "Core",
                "credits": 2,
                "weightage": 5
            },
            {
                "code": "23CS803",
                "name": "Seminar",
                "type": "Core",
                "credits": 2,
                "weightage": 5
            }
        ]
    }
}

# Academic status thresholds
ACADEMIC_STATUS_THRESHOLDS = {
    "Good": {"min_gpa": 8.0, "description": "Excellent academic performance"},
    "Moderate": {"min_gpa": 6.5, "description": "Satisfactory performance"},
    "Need Improvement": {"min_gpa": 0, "description": "Performance needs attention"}
}

# Backlog thresholds (mark < 40 is typically considered a backlog)
BACKLOG_THRESHOLD = 40

# Risk categories for individual subjects
SUBJECT_RISK_THRESHOLDS = {
    "Low": {"min_score": 75},
    "Medium": {"min_score": 60},
    "High": {"min_score": 0}
}

def get_semester_subjects(semester: int) -> dict:
    """Get subjects for a given semester"""
    if semester < 1 or semester > 8:
        return {"error": f"Invalid semester. Must be between 1 and 8."}
    return VTU_2022_CSE_SCHEME.get(semester, {})

def calculate_sgpa(semester: int, subject_marks: dict) -> float:
    """
    Calculate SGPA for a semester
    subject_marks: {"23CS301": 85, "23CS302": 78, ...}
    """
    semester_data = VTU_2022_CSE_SCHEME.get(semester)
    if not semester_data:
        return 0.0
    
    total_gpa = 0.0
    total_credits = 0
    
    for subject in semester_data["subjects"]:
        code = subject["code"]
        if code in subject_marks:
            marks = subject_marks[code]
            # Convert marks to grade points (10-point scale)
            if marks >= 90:
                grade_point = 10
            elif marks >= 80:
                grade_point = 9
            elif marks >= 70:
                grade_point = 8
            elif marks >= 60:
                grade_point = 7
            elif marks >= 50:
                grade_point = 6
            elif marks >= 40:
                grade_point = 5
            else:
                grade_point = 0  # Backlog
            
            total_gpa += grade_point * subject["credits"]
            total_credits += subject["credits"]
    
    if total_credits == 0:
        return 0.0
    
    return round(total_gpa / total_credits, 2)

def calculate_academic_status(sgpa: float) -> str:
    """Determine academic status based on SGPA"""
    if sgpa >= ACADEMIC_STATUS_THRESHOLDS["Good"]["min_gpa"]:
        return "Good"
    elif sgpa >= ACADEMIC_STATUS_THRESHOLDS["Moderate"]["min_gpa"]:
        return "Moderate"
    else:
        return "Need Improvement"

def identify_backlog_subjects(semester: int, subject_marks: dict) -> list:
    """Identify subjects where student has scored below 40 (backlog risk)"""
    semester_data = VTU_2022_CSE_SCHEME.get(semester)
    if not semester_data:
        return []
    
    backlog_subjects = []
    for subject in semester_data["subjects"]:
        code = subject["code"]
        if code in subject_marks and subject_marks[code] < BACKLOG_THRESHOLD:
            backlog_subjects.append({
                "code": code,
                "name": subject["name"],
                "marks": subject_marks[code],
                "type": subject["type"]
            })
    
    return backlog_subjects

def calculate_subject_risk(marks: float) -> str:
    """Calculate risk level for a subject based on marks"""
    if marks >= SUBJECT_RISK_THRESHOLDS["Low"]["min_score"]:
        return "Low"
    elif marks >= SUBJECT_RISK_THRESHOLDS["Medium"]["min_score"]:
        return "Medium"
    else:
        return "High"

def generate_recommendation_plan(semester: int, subject_marks: dict, test_consistency: float) -> dict:
    """
    Generate AI-based recommendation plan
    test_consistency: consistency score from daily tests (0-100)
    """
    semester_data = VTU_2022_CSE_SCHEME.get(semester)
    if not semester_data:
        return {}
    
    backlog_subjects = identify_backlog_subjects(semester, subject_marks)
    weak_subjects = []
    focus_areas = []
    
    for subject in semester_data["subjects"]:
        code = subject["code"]
        if code in subject_marks:
            marks = subject_marks[code]
            risk = calculate_subject_risk(marks)
            
            if risk in ["Medium", "High"]:
                weak_subjects.append({
                    "code": code,
                    "name": subject["name"],
                    "marks": marks,
                    "risk": risk,
                    "type": subject["type"]
                })
    
    # Prioritize core and high-weightage subjects
    weak_subjects.sort(key=lambda x: (x["type"] != "Core", -x.get("marks", 0)))
    
    # Generate focus areas
    if test_consistency < 50:
        focus_areas.append("Improve daily test consistency and regular practice")
    if len(backlog_subjects) > 0:
        focus_areas.append("Focus on preventing backlogs in: " + ", ".join([s["name"] for s in backlog_subjects]))
    
    return {
        "backlog_subjects": backlog_subjects,
        "weak_subjects": weak_subjects[:3],  # Top 3 weakest subjects
        "focus_areas": focus_areas,
        "daily_tasks": generate_daily_tasks(weak_subjects, semester),
        "study_resources": generate_study_resources(semester, weak_subjects)
    }

def generate_daily_tasks(weak_subjects: list, semester: int) -> list:
    """Generate daily tasks based on weak subjects"""
    tasks = []
    for idx, subject in enumerate(weak_subjects[:3]):
        tasks.append({
            "subject": subject["name"],
            "task": f"Solve 5 practice problems on {subject['name'].lower()}",
            "duration_minutes": 45,
            "difficulty": "Medium" if subject["risk"] == "Medium" else "High",
            "day": f"Day {idx + 1}"
        })
    return tasks

def generate_study_resources(semester: int, weak_subjects: list) -> dict:
    """Generate recommended study resources for weak subjects"""
    resources = {
        "online_platforms": [
            "YouTube: VTU lecture channels",
            "Udemy: Advanced courses on weak topics",
            "GitHub: Open-source projects for practical learning"
        ],
        "textbooks": [
            "Reference texts as per VTU curriculum",
            "Previous year question papers"
        ],
        "practice": [
            "Solve at least 50 previous year questions",
            "Attempt 5 mock exams per weak subject",
            "Join study groups for peer learning"
        ]
    }
    return resources

def generate_study_schedule(semester: int, subject_marks: dict, daily_test_scores: list) -> dict:
    """
    Generate AI-based study schedule
    daily_test_scores: list of recent test scores for consistency check
    """
    # Calculate improvement trend
    if len(daily_test_scores) >= 2:
        improvement = daily_test_scores[-1] - daily_test_scores[0]
        trend = "Improving" if improvement > 0 else "Declining" if improvement < 0 else "Consistent"
    else:
        trend = "Insufficient data"
    
    # Calculate consistency
    if daily_test_scores:
        avg_test_score = sum(daily_test_scores) / len(daily_test_scores)
        consistency = (avg_test_score / 100) * 100
    else:
        consistency = 0
    
    return {
        "improvement_trend": trend,
        "consistency_score": round(consistency, 2),
        "weekly_schedule": {
            "monday": "Core subject revision + 10 problems",
            "tuesday": "Weak subject deep dive + 15 problems",
            "wednesday": "Lab work or practical + 5 problems",
            "thursday": "Mock test or practice exam",
            "friday": "Doubt clearing + revision",
            "saturday": "Weekly test + analysis",
            "sunday": "Relaxation and light review"
        },
        "milestones": [
            f"Week 1: Improve weak subjects by 5-10%",
            f"Week 2: Achieve 70% on daily tests",
            f"Week 3: Complete all weak subject topics",
            f"Week 4: Mock exam and final revision"
        ]
    }
