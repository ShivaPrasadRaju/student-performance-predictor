// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  fullName  String  @map("full_name")
  hashedPassword String  @map("hashed_password")
  role      String // "student" or "teacher"
  isActive  Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  studentsManaged Student[]
  sections        Section[]
  predictions     Prediction[]

  @@map("users")
}

// Section model - represents class sections (A, B, C, etc.)
model Section {
  id        Int     @id @default(autoincrement())
  name      String // "A", "B", "C", etc.
  year      Int // Academic year (1-4)
  teacherId Int     @map("teacher_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  teacher   User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  students  Student[]

  @@index([name])
  @@index([year])
  @@index([teacherId])
  @@map("sections")
}

// Student model (teacher's view of students)
model Student {
  id        Int     @id @default(autoincrement())
  studentId String  @unique @map("student_id") // External ID
  name      String
  email     String
  className String  @map("class_name")
  year      Int     @default(1)
  section   String  @default("A")
  sectionId Int?    @map("section_id")
  teacherId Int     @map("teacher_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  teacher       User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  sectionObj    Section?     @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  predictions   Prediction[]

  @@index([email])
  @@index([year])
  @@index([section])
  @@index([teacherId])
  @@index([sectionId])
  @@map("students")
}

// Prediction model - stores prediction history
model Prediction {
  id              Int     @id @default(autoincrement())
  
  // References
  userId          Int     @map("user_id")
  studentId       Int?    @map("student_id")
  
  // Input features
  studyHours      Float   @map("study_hours")
  attendance      Float
  assignmentsScore Float   @map("assignments_score")
  pastMarks       Float   @map("past_marks")
  engagementScore Float   @map("engagement_score")
  
  // Prediction outputs
  predictedScore  Float   @map("predicted_score")
  passFail        String  @map("pass_fail") // "Pass" or "Fail"
  riskCategory    String  @map("risk_category") // "Low", "Medium", "High"
  confidence      Float
  
  // Metadata
  createdAt       DateTime @default(now()) @map("created_at")

  // Relationships
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  student   Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([studentId])
  @@index([createdAt])
  @@map("predictions")
}
